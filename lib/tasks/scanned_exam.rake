namespace :db do
  desc 'Create a populated exam template assignment'
  task scanned_exam: :environment do
    puts 'Assignment 5: Scanned Exam'

    # remove previously existing pdfs to create room for new ones
    FileUtils.rm_rf(Dir.glob('data/dev/exam_templates/*'))

    a = Assignment.create(
      short_identifier: 'midterm1',
      description: 'The first midterm',
      message: 'Illustrates the use of scanned exams.',
      group_min: 1,
      group_max: 1,
      student_form_groups: false,
      group_name_autogenerated: false,
      group_name_displayed: false,
      repository_folder: 'midterm1',
      due_date: 1.minute.from_now,
      allow_web_submits: true,
      display_grader_names_to_students: false,
      submission_rule: NoLateSubmissionRule.new,
      assignment_stat: AssignmentStat.new,
      allow_remarks: true,
      remark_due_date: 7.days.from_now,
      enable_test: false,
      tokens_per_period: 0,
      token_start_date: DateTime.now,
      token_period: 1,
      scanned_exam: true
    )

    file_dir  = File.join(File.dirname(__FILE__), '/../../db/data/scanned_exams')
    f = File.open(File.join(file_dir, 'midterm1.pdf'))
    template = ExamTemplate.create_with_file(f.read, assignment_id: a.id, filename: 'midterm1.pdf')
    template.template_divisions.create(label: 'Q1', start: 2, end: 2)
    template.template_divisions.create(label: 'Q2', start: 3, end: 3)
    template.template_divisions.create(label: 'Q3', start: 3, end: 3)
    template.template_divisions.create(label: 'Q4', start: 4, end: 5)

    template.generate_copies 5
    template_path  = File.join(file_dir, 'midterm1_scanned_sample.pdf')
    template.split_pdf(template_path, 'midterm1_scanned_sample.pdf', Admin.find_by(user_name: 'a'))

    template_path = File.join(file_dir, 'midterm33.pdf')
    template.split_pdf(template_path, 'midterm33.pdf', Admin.find_by(user_name: 'a'))

    template_path = File.join(file_dir, 'midterm35.pdf')
    template.split_pdf(template_path, 'midterm35.pdf', Admin.find_by(user_name: 'a'))

    template_path = File.join(file_dir, 'midterm42.pdf')
    template.split_pdf(template_path, 'midterm42.pdf', Admin.find_by(user_name: 'a'))

    f = File.open(File.join(file_dir, 't1a.pdf'))
    template = ExamTemplate.create_with_file(f.read, assignment_id: a.id, filename: 't1a.pdf')
    template.template_divisions.create(label: 'Q1-a', start: 2, end: 2)
    template.template_divisions.create(label: 'Q1-b', start: 2, end: 3)
    template.template_divisions.create(label: 'Q1-c', start: 4, end: 5)
    template.template_divisions.create(label: 'Q2-a', start: 6, end: 6)
    template.template_divisions.create(label: 'Q2-b', start: 6, end: 6)
    template.template_divisions.create(label: 'Q2-c', start: 6, end: 6)
    template.template_divisions.create(label: 'Q2-d', start: 6, end: 6)
    template.template_divisions.create(label: 'Q3', start: 7, end: 7)

    template_path = File.join(file_dir, 't1a_scanned_example.pdf')
    template.split_pdf(template_path, 't1a_scanned_example.pdf', Admin.find_by(user_name: 'a'))

    f = File.open(File.join(file_dir, 't2a.pdf'))
    template = ExamTemplate.create_with_file(f.read, assignment_id: a.id, filename: 't2a.pdf')
    template.tempalte_divisions.create(label: 'Q1', start: 2, end: 3)
    template.template_divisions.create(label: 'Q2', start: 4, end: 7)
    template.template_divisions.create(label: 'Q3', start: 8, end: 11)

    template_path = File.join(file_dir, 't2a_scanned_example.pdf')
    template.split_pdf(template_path, 't2a_scanned_example.pdf', Admin.find_by(user_name: 'a'))
  end
end
