namespace :db do
  desc 'Create a populated exam template assignment'
  task scanned_exam: :environment do
    puts 'Assignment 5: Scanned Exam'

    # remove previously existing pdfs to create room for new ones
    FileUtils.rm_rf(Dir.glob('data/dev/exam_templates/*'))

    a = Assignment.create(
      short_identifier: 'midterm',
      description: 'The first midterm',
      message: 'Illustrates the use of scanned exams.',
      group_min: 1,
      group_max: 1,
      student_form_groups: false,
      group_name_autogenerated: false,
      group_name_displayed: false,
      repository_folder: 'midterm',
      due_date: 1.minute.from_now,
      allow_web_submits: true,
      display_grader_names_to_students: false,
      submission_rule: NoLateSubmissionRule.new,
      assignment_stat: AssignmentStat.new,
      allow_remarks: true,
      remark_due_date: 7.days.from_now,
      enable_test: false,
      tokens_per_period: 0,
      token_start_date: DateTime.now,
      token_period: 1,
      scanned_exam: true
    )

    # For a description of the seed files, see db/data/scanned_exams/README.md.
    file_dir  = File.join(File.dirname(__FILE__), '/../../db/data/scanned_exams')
    f = File.open(File.join(file_dir, 'midterm1-v2-test.pdf'))
    template = ExamTemplate.create_with_file(f.read, assignment_id: a.id, filename: 'midterm1-v2-test.pdf')
    template.template_divisions.create(label: 'Q1', start: 3, end: 3)
    template.template_divisions.create(label: 'Q2', start: 4, end: 4)
    template.template_divisions.create(label: 'Q3', start: 5, end: 6)

    admin = Admin.first

    %w(1-20 100 101 102 103 104).each do |n|
      template_path = File.join(file_dir, "midterm_scan_#{n}.pdf")
      template.split_pdf(template_path, "midterm_scan_#{n}.pdf", admin)
    end
  end
end
