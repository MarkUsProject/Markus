namespace :db do
  desc 'Create a populated exam template assignment'
  task scanned_exam: :environment do
    puts 'Assignment 5: Scanned Exam'
    a = Assignment.create(
      short_identifier: 'midterm1',
      description: 'The first midterm',
      message: 'Illustrates the use of scanned exams.',
      group_min: 1,
      group_max: 1,
      student_form_groups: false,
      group_name_autogenerated: false,
      group_name_displayed: false,
      repository_folder: 'midterm1',
      due_date: 1.minute.from_now,
      allow_web_submits: true,
      display_grader_names_to_students: false,
      submission_rule: NoLateSubmissionRule.new,
      assignment_stat: AssignmentStat.new,
      allow_remarks: true,
      remark_due_date: 7.days.from_now,
      enable_test: false,
      tokens_per_period: 0,
      token_start_date: DateTime.now,
      token_period: 1,
      scanned_exam: true
    )

    file_dir  = File.join(File.dirname(__FILE__), '/../../db/data/scanned_exams')
    f = File.open(File.join(file_dir, 'midterm1.pdf'))
    template = ExamTemplate.create_with_file(f.read, assignment_id: a.id, filename: 'midterm1.pdf')
    template.template_divisions.create_with_associations(a.id, label: 'Q1', start: 2, end: 2)
    template.template_divisions.create_with_associations(a.id, label: 'Q2', start: 3, end: 3)
    template.template_divisions.create_with_associations(a.id, label: 'Q3', start: 3, end: 3)
    template.template_divisions.create_with_associations(a.id, label: 'Q4', start: 4, end: 5)

    template.generate_copies 5
    template_path  = File.join(File.dirname(__FILE__), '/../../db/data/scanned_exams/midterm1_scanned_sample.pdf')
    template.split_pdf template_path
  end
end
