/**
 * Page-specific event handlers for assignments/new.html.erb
 */

jQuery(document).ready(function() {
  jQuery('#assignment_due_date').change(function() {
    update_due_date(jQuery(this).val());
  });

  jQuery('#assignment_section_due_dates_type').change(function() {
    toggle_sections_due_date(jQuery(this).is(':checked'));
  });
});

function toggle_persist_groups(persist_groups) {
  jQuery('#is_group_assignment').prop('disabled', persist_groups);
  jQuery('#is_group_assignment_style').toggleClass('disable', persist_groups);

  if (persist_groups) {
    toggle_group_assignment(false);
  }
}

function toggle_group_assignment(is_group_assignment) {
  jQuery('#is_group_assignment').prop('checked', is_group_assignment);

  jQuery('.group_properties').prop('disabled', !is_group_assignment);
  jQuery('.group_properties').toggleClass('disable', !is_group_assignment);
  jQuery('#assignment_group_min').prop('disabled', !is_group_assignment);
  jQuery('#assignment_group_max').prop('disabled', !is_group_assignment);

  jQuery('#persist_groups').prop('disabled', is_group_assignment);
  jQuery('#persist_groups_assignment').prop('disabled', is_group_assignment);
  jQuery('#persist_groups_assignment_style').toggleClass('disable', is_group_assignment);
}

function toggle_student_form_groups(student_form_groups) {
  jQuery('#assignment_group_min').prop('disabled', !student_form_groups);
  jQuery('#assignment_group_max').prop('disabled', !student_form_groups);
  jQuery('#group_limit_style').toggleClass('disable', !student_form_groups);
  jQuery('#group_name_autogenerated_style').toggleClass('disable', student_form_groups);
  jQuery('#assignment_group_name_autogenerated').prop('disabled', student_form_groups);

  if (student_form_groups) {
    jQuery('#assignment_group_name_autogenerated').prop('checked', true);
  }
}

function toggle_remark_requests(allow_remark_requests) {
  jQuery('#allow_remarks').prop('checked', allow_remark_requests);

  jQuery('#remark_due_date').prop('disabled', !allow_remark_requests);
  jQuery('#assignment_remark_message').prop('disabled', !allow_remark_requests);

  jQuery('#remark_properties').toggleClass('disable', !allow_remark_requests);
}

function toggle_automated_tests(is_testing_framework_enabled) {
  $('is_testing_framework_enabled').setValue(is_testing_framework_enabled);

  if (is_testing_framework_enabled) {
    $('tokens').removeClassName('disable');
    $('tokens_per_day').enable();

    $$('#antbuildfile_style').each(function(node) { node.removeClassName('disable'); });
    $$('#antbuildfile_style input').each(function(node) {
      $(node).enable();
    });
    $$('#antbuildprop_style').each(function(node) { node.removeClassName('disable'); });
    $$('#antbuildprop_style input').each(function(node) {
      $(node).enable();
  });
    $$('#test_files .test_file').each(function(node) { node.removeClassName('disabled'); });
    $$('#test_files .test_file input').each(function(node) {
      $(node).enable();
    });
    $$('#lib_files .test_file').each(function(node) { node.removeClassName('disabled'); });
    $$('#lib_files .test_file input').each(function(node) {
      $(node).enable();
    });
    $$('#parser_files .test_file').each(function(node) { node.removeClassName('disabled'); });
    $$('#parser_files .test_file input').each(function(node) {
      $(node).enable();
    });
  } else {
    $('tokens').addClassName('disable');
    $('tokens_per_day').disable();

    $$('#antbuildfile_style').each(function(node) { node.addClassName('disable'); });
    $$('#antbuildfile_style input').each(function(node) {
      $(node).disable();
    });
    $$('#antbuildprop_style').each(function(node) { node.addClassName('disable'); });
    $$('#antbuildprop_style input').each(function(node) {
      $(node).disable();
    });
    $$('#test_files .test_file').each(function(node) { node.addClassName('disabled'); });
    $$('#test_files .test_file input').each(function(node) {
      $(node).disable();
    });
    $$('#lib_files .test_file').each(function(node) { node.addClassName('disabled'); });
    $$('#lib_files .test_file input').each(function(node) {
      $(node).disable();
    });
    $$('#parser_files .test_file').each(function(node) { node.addClassName('disabled'); });
    $$('#parser_files .test_file input').each(function(node) {
      $(node).disable();
    });
  }
}

function request_group_properties(assignment_id) {
/*  new Ajax.Request('update_group_properties_on_dependency', {asynchronous:true, evalScripts:true, parameters:'assignment_id=' + $F('assignment_dependency_list')}*/
}

function update_group_properties(is_group_assignment, student_form_groups, group_min, group_max, group_name_autogenerated) {
  jQuery('#is_group_assignment').val(is_group_assignment);
  jQuery('#student_form_groups').val(student_form_groups);
  jQuery('#assignment_group_min').val(group_min);
  jQuery('#assignment_group_max').val(group_max);
  jQuery('#assignment_group_name_autogenerated').val(group_name_autogenerated);

  jQuery('#is_group_assignment').prop('disabled', true);
  jQuery('#is_group_assignment').addClass('disable');
  jQuery('#student_form_groups').prop('disabled', true);
  jQuery('#student_form_groups_style').addClass('disable');
  jQuery('#assignment_group_min').prop('disabled', true);
  jQuery('#assignment_group_max').prop('disabled', true);
  jQuery('#group_limit_style').addClass('disable');
  jQuery('#assignment_group_name_autogenerated').prop('disabled', true);
  jQuery('#group_name_autogenerated_style').addClass('disable');
}

function add_assignment_file() {
  var new_assignment_file_div = new Element('div', {'class': 'assignment_file'})
  var new_assignment_file = new Element('input', {'type': 'text', 'name': 'assignment_files[]'})
  new_assignment_file.observe('keydown', function(e) {
    if(e.keyCode == Event.KEY_RETURN) {
      e.stop();
    }
  });
  var remove_link = new Element('a', {'href': 'javascript:void(0);'})
  remove_link.update('x');
  remove_link.observe('click', function(e) {
    $(new_assignment_file_div).remove();
  });
  new_assignment_file_div.insert(new_assignment_file);
  new_assignment_file.insert({'after': remove_link});
  $('assignment_files').insert(new_assignment_file_div);
  $(new_assignment_file).activate();
}

function default_group_fields() {
  toggle_persist_groups(false);
  toggle_group_assignment(false);
  toggle_remark_requests(true);
}

function update_due_date(new_due_date) {
  // Does nothing if {grace, penalty_decay, penalty}_periods already created
  create_grace_periods();
  create_penalty_decay_periods();
  create_penalty_periods();

  grace_periods.set_due_date(new_due_date);
  penalty_decay_periods.set_due_date(new_due_date);
  penalty_periods.set_due_date(new_due_date);
  grace_periods.refresh();
  penalty_decay_periods.refresh();
  penalty_periods.refresh();
}

function toggle_sections_due_date(section_due_dates_type) {
  jQuery('#section_due_dates_information').toggle(section_due_dates_type);
}

function change_submission_rule() {
  $$('.period').each(function(node) { node.removeClassName('disabled'); node.show(); });
  $$('.period input').each(function(node) {
    $(node).enable();
  });

  if ($('grace_period_submission_rule').getValue() == null) {
    $("grace_period_link").hide();
    // Disable any grace_period_submission_rule periods
    $$('#grace_periods .period').each(function(node) { node.addClassName('disabled'); node.hide(); });
    $$('#grace_periods .period input').each(function(node){node.disable();});
  } else {
    $("grace_period_link").show();
    if ($$('#grace_periods .period').length == 0) {
      // Auto expand add a grace period if needed
      $("grace_period_link").onclick();
    }
  }

  if ($('penalty_decay_period_submission_rule').getValue() == null) {
    $("penalty_decay_period_link").hide();
    // Disable any penalty_decay_period_submission_rule periods
    $$('#penalty_decay_periods .period').each(function(node) { node.addClassName('disabled'); node.hide(); });
    $$('#penalty_decay_periods .period input').each(function(node){node.disable();});
  } else {
    $("penalty_decay_period_link").show();
    if ($$('#penalty_decay_periods .period').length == 0) {
       // Auto expand add a penalty period if needed
      $("penalty_decay_period_link").onclick();
    }
  }

  if ($('penalty_period_submission_rule').getValue() == null) {
    $("penalty_period_link").hide();
    // Disable any penalty_period_submission_rule periods
    $$('#penalty_periods .period').each(function(node) { node.addClassName('disabled'); node.hide(); });
    $$('#penalty_periods .period input').each(function(node){node.disable();});
  } else {
    $("penalty_period_link").show();
    if ($$('#penalty_periods .period').length == 0) {
      // Auto expand add a penalty period if needed
      $("penalty_period_link").onclick();
    }
  }
}

function notice_marking_scheme_changed(is_assignment_new, clicked_marking_scheme_type, marking_scheme_type) {
  if (is_assignment_new != true && clicked_marking_scheme_type != marking_scheme_type) {
    if ($('marking_scheme_notice').hasClassName('hidden')) {
      $('marking_scheme_notice').removeClassName('hidden');
    }
    $('marking_scheme_notice').show();
  } else {
    $('marking_scheme_notice').hide();
  }
}
