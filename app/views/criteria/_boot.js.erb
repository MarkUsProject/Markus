<script>
  $(document).ready(function() {
    bindSortable();

    var ajaxRequest;
    function bindSortable() {
      $('.sortable ul').sortable({
        axis:   'y',
        cursor: 'move',
        update: function() {
          // Cancel any previous requests
          if (typeof ajaxRequest !== 'undefined') {
            ajaxRequest.abort();
          }

          ajaxRequest = $.ajax({
            url:  '<%= update_positions_assignment_criteria_path(@assignment) %>',
            type: 'POST',
            data: $('.sortable ul').sortable('serialize'),
            dataType: 'script',
            success: function(response) {
              ajaxRequest = undefined;
              bindSortable();
            }
          });
        },
        cancel: '#new_criterion'
      });
    }
  });

  function add_level(id) {
    let rubric_form = $('#' + id);
    let last_level = $('#' + id + " .level").first();
    let new_level = last_level.clone();

    // use regular expressions to update level numbers
    let regex = new RegExp(/\d+/);
    let level_num = $('#' + id + " .level").length;
    // replace the new level names with the new level number
    let new_name = $(new_level)[0].childNodes[1];
    $(new_name).text(I18.t("rubric_criteria.level.name"));
    let display_name = new_level.find('label')[0];
    $(display_name).text('Delete New Level');

    // clear the inputs and text areas and create unique ids and names
    new_level.find('input').each(function () {
      if ($(this).attr('id')) {
        $(this).attr('id', $(this).attr('id').replace(regex, level_num));
      }
      if ($(this).attr('name')) {
        $(this).attr('name', $(this).attr('name').replace(regex, level_num));
      }
      $(this).val('');
    });
    new_level.find('textarea').each(function () {
      if ($(this).attr('id')) {
        $(this).attr('id', $(this).attr('id').replace(regex, level_num));
      }
      if ($(this).attr('name')) {
        $(this).attr('name', $(this).attr('name').replace(regex, level_num));
      }
      $(this).val('');
    });
    rubric_form.prepend(new_level);
  }
</script>
