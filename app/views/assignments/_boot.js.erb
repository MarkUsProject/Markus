<script>
//<![CDATA[
  var past_due_date = '<%= t(:past_due_date_edit_warning) %>';

  var grace_periods = null;
  var penalty_decay_periods = null;
  var penalty_periods = null;


  function create_grace_periods() {
    if (!grace_periods) {
      grace_periods = new PeriodDeltaChain({
        period_root_id: 'grace_periods',
        date_format: document.getElementById('format').value,
        due_date: jQuery('#actual_assignment_due_date').val()
      });
    }
  }

  function create_penalty_decay_periods() {
    if (!penalty_decay_periods) {
      penalty_decay_periods = new PeriodDeltaChain({
        period_root_id: 'penalty_decay_periods',
        date_format: document.getElementById('format').value,
        due_date: jQuery('#actual_assignment_due_date').val()
      });
    }
  }

  function create_penalty_periods() {
    if (!penalty_periods) {
      penalty_periods = new PeriodDeltaChain({
        period_root_id: 'penalty_periods',
        date_format: document.getElementById('format').value,
        due_date: jQuery('#actual_assignment_due_date').val()
      });
    }
  }

  function check_fields(elems) {
    var empty = false;
    jQuery(elems).each(function() {
      if (this.value === '') {
        empty = true;
      }
    });

    jQuery('input[type="submit"]').prop('disabled', empty);
  }

  function check_required_fields() {
    check_fields('input[required');
  }

  function check_rule_periods() {
    check_fields('.period input');
  }

  jQuery(document).ready(function() {
    // Set locale for language localisation with Moment.js
    moment.lang(document.getElementById('locale').value);

    // Handle periods and hiding/showing things
    if (jQuery('#actual_assignment_due_date').val()) {
      create_grace_periods();
      create_penalty_decay_periods();
      create_penalty_periods();

      grace_periods.refresh();
      penalty_decay_periods.refresh();
      penalty_periods.refresh();

      default_group_fields();
      <% if !@assignment.nil? %>
        toggle_group_assignment(<%= @assignment.group_assignment? %>);
        toggle_remark_requests(<%= @assignment.allow_remarks? %>);
      <% end %>
    }

    // Localize the due dates on load
    var format = document.getElementById('format').value;
    localize_datetime(document.getElementById('actual_assignment_due_date'),
                      document.getElementById('assignment_due_date'),
                      format);
    localize_datetime(document.getElementById('actual_remark_due_date'),
                      document.getElementById('remark_due_date'),
                      format);
    jQuery('.section_due_date').each(function(i) {
      localize_datetime(document.getElementById('actual_section_due_date_' + (i+1)),
                        document.getElementById('section_due_date_' + (i+1)),
                        format);
    });

    // Handle required fields
    check_required_fields();
    jQuery('input[required]').change(check_required_fields)
                             .keyup(check_required_fields);

    jQuery('.period input')

    if (jQuery('#grace_period_submission_rule').is(':checked')) {
      jQuery('#grace_periods .period input').prop('disabled', false);
    }

    if (jQuery('#penalty_decay_period_submission_rule').is(':checked')) {
      jQuery('#penalty_decay_periods .period input').prop('disabled', false);
    }

    if (jQuery('#penalty_period_submission_rule').is(':checked')) {
      jQuery('#penalty_periods .period input').prop('disabled', false);
    }

    // Handle date/time pickers
    jQuery('.section_due_date').each(function(i) {
      jQuery('#section_due_date_' + (i+1)).datetimepicker({
        altField:         '#actual_section_due_date_' + (i+1),
        altFieldTimeOnly: false,
        altFormat:        'yy-mm-dd',
        altTimeFormat:    'HH:mm',
        altSeparator:     'T',
        controlType:      'select',
        showTime:         false,
        numberOfMonths:   2,
        secondMax:        0,
        onClose:          function() { check_due_date(jQuery('#actual_section_due_date').val()); },
        dateFormat:       "<%= raw t('date.formats.locale_date') %>",
        timeFormat:       "<%= t('time.formats.locale_time') %>",
        monthNames:       <%= raw t('date.months') %>,
        dayNames:         <%= raw t('date.weekdays') %>,
        dayNamesMin:      <%= raw t('date.weekdays_min') %>,
        hourText:         "<%= t('time.hour') %>",
        minuteText:       "<%= t('time.minute') %>",
        timeText:         "<%= t('time.time') %>",
        prevText:         "<%= t('time.prev') %>",
        nextText:         "<%= t('time.next') %>",
        closeText:        "<%= t('time.close') %>",
      });
    });

    jQuery('#assignment_due_date').datetimepicker({
      altField:         '#actual_assignment_due_date',
      altFieldTimeOnly: false,
      altFormat:        'yy-mm-dd',
      altTimeFormat:    'HH:mm',
      altSeparator:     'T',
      controlType:      'select',
      showTime:         false,
      numberOfMonths:   2,
      secondMax:        0,
      onClose:          function() { jQuery('#assignment_due_date').change();
                                     check_due_date(jQuery('#actual_assignment_due_date').val()); },
      dateFormat:       "<%= raw t('date.formats.locale_date') %>",
      timeFormat:       "<%= t('time.formats.locale_time') %>",
      monthNames:       <%= raw t('date.months') %>,
      dayNames:         <%= raw t('date.weekdays') %>,
      dayNamesMin:      <%= raw t('date.weekdays_min') %>,
      hourText:         "<%= t('time.hour') %>",
      minuteText:       "<%= t('time.minute') %>",
      timeText:         "<%= t('time.time') %>",
      prevText:         "<%= t('time.prev') %>",
      nextText:         "<%= t('time.next') %>",
      closeText:        "<%= t('time.close') %>",
    });

    jQuery('#remark_due_date').datetimepicker({
      altField:         '#actual_remark_due_date',
      altFieldTimeOnly: false,
      altFormat:        'yy-mm-dd',
      altTimeFormat:    'HH:mm',
      altSeparator:     'T',
      controlType:      'select',
      showTime:         false,
      numberOfMonths:   2,
      secondMax:        0,
      onClose:          function() { check_due_date(jQuery('#actual_remark_due_date').val()); },
      dateFormat:       "<%= raw t('date.formats.locale_date') %>",
      timeFormat:       "<%= t('time.formats.locale_time') %>",
      monthNames:       <%= raw t('date.months') %>,
      dayNames:         <%= raw t('date.weekdays') %>,
      dayNamesMin:      <%= raw t('date.weekdays_min') %>,
      hourText:         "<%= t('time.hour') %>",
      minuteText:       "<%= t('time.minute') %>",
      timeText:         "<%= t('time.time') %>",
      prevText:         "<%= t('time.prev') %>",
      nextText:         "<%= t('time.next') %>",
      closeText:        "<%= t('time.close') %>",
    });
  });
//]]>
</script>
