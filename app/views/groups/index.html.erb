<% content_for :head do %>
  <%= javascript_include_tag 'manage_groups.js',
                             'FilterTable/FilterTable.js',
                             'Groups/tabs_boot.js',
                             'Groups/index' %>

  <%= render :partial => 'layouts/head' %>

  <%= render :partial => "boot.js.erb" %>

  <script type="text/javascript">
  //<![CDATA[

  var modalCreate = null;
  var modalAssignmentGroupReUse = null;
  var modalAddMember = null;
  var modalNotesGroup = null;

  function make_new_group() {
    if (<%= @assignment.group_name_autogenerated == false %>)
    {
      modalCreate.open();
      $('new_group_name').setValue('');
      return false;
    }
    else
    {
    	new Ajax.Request('<%= new_assignment_group_path(@assignment)%>',
                      {
                        asynchronous:true,
                        evalScripts:true,
                        method:'get',
                        parameters: 'authenticity_token=' + AUTH_TOKEN
                      })
    }
  }

  function submit_new_group(new_group_name) {

    //close the dialog
    modalCreate.close();
    //send AJAX request
    new Ajax.Request('<%= new_assignment_group_path(@assignment)%>',
                     {
                        asynchronous:true,
                        evalScripts:true,
                        method:'get',
                        parameters:'&new_group_name=' + new_group_name +
                        '&authenticity_token=' + AUTH_TOKEN
                      })
  }

  function assignment_group_use() {
      modalAssignmentGroupReUse.open();
      $('clone_groups_assignment_id').setValue('');
      return false;
   }

  function submit_assignment_group_use(clone_groups_assignment_id) {

    // close the dialog
    modalAssignmentGroupReUse.close();

    // send AJAX request
    new Ajax.Request('<%= use_another_assignment_groups_assignment_groups_path(@assignment)%> ',
                      {
                        asynchronous:true,
                        evalScripts:true,
                        parameters:'&clone_groups_assignment_id=' + clone_groups_assignment_id
                          + '&authenticity_token=' + AUTH_TOKEN
                      })
  }

  document.observe("dom:loaded", function() {
    modalCreate = new Control.Modal($('create_group_dialog'),
    {
      overlayOpacity: 0.75,
      className: 'modalCreate',
      fade:false
    });

    modalNotesGroup = new Control.Modal($('notes_dialog'),
    {
      overlayOpacity: 0.75,
      className: 'modalNotesGroup',
      fade:false
    });

    modalAssignmentGroupReUse = new Control.Modal($('assignment_group_use_dialog'),
    {
      overlayOpacity: 0.75,
      className: 'modalAssignmentGroupReUse',
      fade:false
    });

    // set up event handlers to show the loading spinner while
    // an ajax call us working
    $("global_action_form").observe('ajax:after', function(evt, status, data, xhr) {
      thinking();
    });

    $("global_action_form").observe('ajax:success', function(evt, status, data, xhr) {
      done_thinking();
    });

  });

  //]]>
  </script>
<% end %>


<% if @assignment.past_due_date? %>
<div class="notice">
  <%=t('groups.editing_past_due_date_warning')%>
</div>
<% end %>

<div id="title_bar">
  <h1><%= I18n.t("groups.manage_groups") %></h1>
  <div class="colRightGroups">
      <div class="headingButtons  ">
      <%  # Allow cloning groups forward only if its web submits are disallowed
          # for this assignment.
          if @assignment.allow_web_submits == false %>
        <%= button_to_function t("groups.another_assignment_group"),
          'assignment_group_use(); return false;', :class => "button" %>
        <span class="menu_bar">|</span>
      <% end %>
      <%= button_to_function I18n.t('download'), 'modal_download.open();' %>
      <span class="menu_bar">|</span>
      <%= button_to_function I18n.t('upload'), 'modal_upload.open();' %>
    </div> <!-- rightjustify-->
  </div> <!-- colrightgroups-->

  </div> <!-- title_bar-->


<div class="wrapLeft">
</div>

<div class="clear"></div>

<div id="notice">
    <div class="success" id="add_success" style="display: none; ">
            </div>
  <% # This is for error display injected by JavaScript
   %>

  <div class="error" id="errors" style="display: none; ">
    <h3><%= t("groups.problem") %></h3>
    <div id="errors_title">
    </div>
    <div id="errors_contents">
    </div>
  </div>

  <div class="warning" id="warnings_group" style="display: none; ">
    <h3><%= t("groups.warning") %></h3>
    <div id="warnings_group_msg">
    </div>
  </div>

  <div class="warning" id="warnings_grace" style="display: none; ">
    <h3><%= t("groups.warning") %></h3>
    <div id="warnings_grace_msg">
    </div>
  </div>
 <div class="warning" id="global_action_warning" style="display: none; ">
	<h3><%= t("groups.warning") %></h3>
	<div id="global_action_warning_msg">
	</div>
  </div>

  <% # all other flash messages %>
  <%= render 'shared/flash_message' %>
</div><!-- Notice -->



<%= form_tag global_actions_assignment_groups_path(@assignment),
             :id => "global_action_form",
             :remote => true do %>


<div class="clear"></div>
<div class="colsLeftHeavy">
  <div class="colRightGroups">
    <div class="wrapRightGroups">
      <div class="pane">
        <span id="loading_list">
          <%= image_tag("spinner.gif") %><%= t("groups.loading_list") %></span>
        <ul id="groups_tabs"class="subsection_tabs">
          <li class="tab">
            <a href="#none" id="filter_link_none" class="filter_selected">
              <%= raw(I18n.t("groups.all_grouping_counts")) %></a></li>
          <li class="tab">
            <a href="#validated" id="filter_link_validated">
              <%= raw(I18n.t("groups.valid_grouping_counts")) %></a></li>
          <li class="tab">
            <a href="#unvalidated" id="filter_link_unvalidated">
              <%= raw(I18n.t("groups.not_valid_grouping_counts")) %></a></li>
          <li class="button_tab">

          </li>
        </ul>
        <div id="none"></div>
        <div id="validated"></div>
        <div id="unvalidated"></div>

        <div class="clear"></div>
        <div id="groups_container" class="tabbedArea">
          <%= label_tag 'search_groupings', "Search:", :class => 'bold_inline_label'%>
          <%= text_field_tag 'search_groupings', nil,
            :onkeyup => "groupings_table.add_filter('search'); groupings_table.render();",
            :onkeypress => "stop_submit(event);"%>
          <%= button_to_function t('groups.add_new'), "make_new_group()" %>
          <div class="globalActionIconsTop">
            <%= image_submit_tag "icons/tick.png",
              :class =>'image_input',
              :title => I18n.t("groups.action.validate"),
              :alt => I18n.t("groups.action.validate"),
              :onclick => "$('global_actions').setValue('valid');" %>
            <%= image_submit_tag "icons/cross.png",
              :class =>'image_input',
              :title => I18n.t("groups.action.invalidate"),
              :alt => I18n.t("groups.action.invalidate"),
              :onclick => "$('global_actions').setValue('invalid');" %>
            <%= image_submit_tag "icons/bin_closed.png",
              :class =>'image_input', :title => I18n.t("groups.action.delete"),
              :alt => I18n.t("groups.action.delete"),
              :onclick => "$('global_actions').setValue('delete');" %>
          </div>
          <table class="groups" id="groups">
          </table>
          <%= hidden_field_tag 'submit_type', 'global_action', :id => 'submit_type' %>
          <%= hidden_field_tag 'global_actions'%>
          <div class="globalActionIconsBottom">
            <%= image_submit_tag "icons/tick.png",
              :class =>'image_input',
              :title => I18n.t("groups.action.validate"),
              :alt => I18n.t("groups.action.validate"),
              :onclick => "$('global_actions').setValue('valid');" %>
            <%= image_submit_tag "icons/cross.png",
              :class =>'image_input',
              :title => I18n.t("groups.action.invalidate"),
              :alt => I18n.t("groups.action.invalidate"),
              :onclick => "$('global_actions').setValue('invalid');" %>
            <%= image_submit_tag "icons/bin_closed.png",
              :class =>'image_input',
              :title => I18n.t("groups.action.delete"),
              :alt => I18n.t("groups.action.delete"),
              :onclick => "$('global_actions').setValue('delete');" %>
          </div>
        </div><!-- group container -->
      </div>
    </div>
  </div> <!-- colRightGroups -->

  <div class="colLeftGroups">
    <% # order of processing students is important. we go through each member
       # one by one and delete them above from the list of students
       # if they are already in a group
       # See manage/_group.html.erb
    %>
    <div class="wrapLeftGroups">
      <div class="pane">
        <span id="loading_students_list">
          <%= image_tag("spinner.gif") %><%= t("groups.loading_list") %></span>
        <ul id="students_tabs" class="subsection_tabs">
          <li class="tab">
            <a href="#students_none" id="filter_link_students_none">
              <%= raw(I18n.t("groups.all_students")) %></a></li>
          <li class="tab">
            <a href="#unassigned" id="filter_link_students_unassigned" class="filter_selected">
              <%= raw(I18n.t("groups.unassigned_students")) %></a></li>
          <li class="tab"><a href="#assigned" id="filter_link_students_assigned">
            <%= raw(I18n.t("groups.assigned_students")) %></a></li>
        </ul>

        <div id="students_none"></div>
        <div id="unassigned"></div>
        <div id="assigned"></div>

        <div class="tabbedArea">
          <div class="searchBox">
            <%= label_tag 'search_students', "Search:",
              :class => 'bold_inline_label'%>
            <%= text_field_tag 'search_students', nil,
               :onkeyup => "students_table.add_filter('search'); students_table.render();",
               :onkeypress => "stop_submit(event);" %>
          </div>
          <table class="students" id="students">
          </table>
        </div>

      </div>
    </div>
  </div> <!-- colLeftGroups -->

  <div id="centreColumn" class="centreColumn">
      <%= image_submit_tag "add_arrow.png",
        :onclick => "$('global_actions').setValue('assign');",
        :alt => I18n.t('add_members'),
        :class =>'image_input',
        :title => I18n.t('add_members') %>
      <br/><br/>
      <%= image_submit_tag "remove_arrow.png",
        :onclick => "$('global_actions').setValue('unassign');",
        :alt => I18n.t('remove_members'),
        :title => I18n.t('remove_members'),
        :class =>'image_input' %>
  </div>

</div> <!-- ColsLeftHeavy -->
<% end %> <!-- remote form tag -->

<!-- Modal Windows -->



<div id="assignment_group_use_dialog">
  <h2><%= I18n.t("groups.reuse_groups") %></h2>
  <fieldset>
  <p><%= I18n.t("groups.assignment_to_use") %></p>
  <select id="clone_groups_assignment_id" name="clone_groups_assignment_id">
    <% @all_assignments.each do |an_assignment| %>
      <% if an_assignment != @assignment && an_assignment.allow_web_submits == false %>
        <option value="<%=(an_assignment.id)%>"><%=(an_assignment.short_identifier)%></option>
      <% end %>
    <% end %>
  </select>
  </fieldset>
  <p class="p_modal">
    <%= button_to_function t(:submit),
     "if (confirm(\"#{I18n.t('groups.delete_groups_linked')}\")) submit_assignment_group_use(escape($F('clone_groups_assignment_id')))" %>
    <%= button_to_function t(:cancel), 'modalAssignmentGroupReUse.close()'%>
  </p>
</div> <!-- Assignement reuse groups modal-->

<div id="create_group_dialog">
  <h2><%= I18n.t("groups.create_new_group") %></h2>
  <fieldset>
  <%= I18n.t("groups.groupe_name") %>
  <input type="text" maxlength="30" id="new_group_name"></input>
  </fieldset>
  <p class="p_modal">
    <%= button_to_function I18n.t("groups.create_new_group"),
  "submit_new_group(escape($F('new_group_name')));" %>
    <%= button_to_function t(:cancel), 'modalCreate.close()'%>
  </p>

</div>

<div id="rename_group_dialog">
</div>

<div id="notes_dialog">
</div>

<div id="download_dialog">
  <h2><%= I18n.t("groups.download.download_groups_file") %></h2>
  <%= link_to t('groups.download.download_csv'),
              { :controller => 'groups', :action => 'download_grouplist',
                :id => @assignment.id },
              :onclick => 'modal_download.close();' %>
  <br />
  <br />
  <%= button_to_function I18n.t('cancel'),
                         'modal_download.close(); return false;' %>
</div>

<div id="upload_dialog">
  <h2><%= I18n.t("groups.upload.upload_groups_file") %></h2>
  <p>
    <%= I18n.t("groups.upload.description").html_safe %>
    <% if !@assignment.groupings.nil? && @assignment.groupings.length > 0 %>
      <br/>
      <div class="information">
        <%= I18n.t("groups.upload.importing") %>
      </div>
    <% end %>
  </p>
  <%= form_for :group, :html => {:multipart => true},
                       :url => { :controller=>"groups",
                               :action => 'csv_upload',
                               :id => @assignment.id } do |f| %>
  <p>
    <%= I18n.t("encoding") %>
    <%= select_tag(:encoding, options_for_select(@encodings)) %>
    <br />
    <br />
    <%= f.file_field :grouplist, :size => 2 %> <br />
    <%= submit_tag t(:upload), :disable_with => t(:uploading_please_wait) %>
    <%= button_to_function I18n.t('cancel'),
                           'modal_upload.close(); return false;' %>
  </p>
  <% end %>
</div>
