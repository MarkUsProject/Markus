<% content_for :head do %>
  <%= javascript_include_tag 'manage_groups.js',
                             'FilterTable/FilterTable.js',
                             'Groups/tabs_boot.js',
                             'Groups/index' %>

  <%= render partial: 'layouts/head' %>

  <%= render partial: "boot", formats: [:js], handlers: [:erb] %>

  <script>
  //<![CDATA[
    var modalCreate     = null;
    var modalAddMember  = null;
    var modalNotesGroup = null;
    var modalAssignmentGroupReUse = null;

    function make_new_group() {
      <% if @assignment.group_name_autogenerated %>
        new Ajax.Request('<%= new_assignment_group_path(@assignment)%>',
                {
                    asynchronous:true,
                    evalScripts:true,
                    method:'get',
                    parameters: 'authenticity_token=' + AUTH_TOKEN
                })

      <% else %>
        modalCreate.open();
        document.getElementById('new_group_name').value = '';
        return false;
      <% end %>
    }

    function submit_new_group(new_group_name) {
      // Close the dialog
      modalCreate.close();
      // Send AJAX request
      new Ajax.Request('<%= new_assignment_group_path(@assignment)%>',
                       {
                          asynchronous:true,
                          evalScripts:true,
                          method:'get',
                          parameters:'&new_group_name=' + new_group_name +
                          '&authenticity_token=' + AUTH_TOKEN
                        })
    }

    function assignment_group_use() {
      modalAssignmentGroupReUse.open();
      document.getElementById('clone_groups_assignment_id').val = '';
      return false;
    }

    function submit_assignment_group_use(clone_groups_assignment_id) {
      // Close the dialog
      modalAssignmentGroupReUse.close();

      // Send AJAX request
      new Ajax.Request('<%= use_another_assignment_groups_assignment_groups_path(@assignment)%> ',
                        {
                          asynchronous:true,
                          evalScripts:true,
                          parameters:'&clone_groups_assignment_id=' + clone_groups_assignment_id
                            + '&authenticity_token=' + AUTH_TOKEN
                        })
    }

    jQuery(document).ready(function() {
      modalCreate = new ModalMarkus('#create_group_dialog');
      modalNotesGroup = new ModalMarkus('#notes_dialog');
      modalAssignmentGroupReUse = new ModalMarkus('#assignment_group_use_dialog');

      // set up event handlers to show the loading spinner while
      // an ajax call us working
      $("global_action_form").observe('ajax:after', function(evt, status, data, xhr) {
        thinking();
      });

      $("global_action_form").observe('ajax:success', function(evt, status, data, xhr) {
        done_thinking();
      });
    });
  //]]>
  </script>
<% end %>

<% if @assignment.past_due_date? %>
  <div class="warning">
    <%= t('groups.editing_past_due_date_warning') %>
  </div>
<% end %>

<div class="title_bar">
  <h1><%= t("groups.manage_groups") %></h1>
  <div class="heading_buttons">
    <%  # Allow cloning groups forward only if its web submits are disallowed
        # for this assignment.
        if !@assignment.allow_web_submits %>
      <%= link_to t("groups.another_assignment_group"),
                  '#',
                  onclick: 'assignment_group_use(); return false;' %>
      <span class="menu_bar"></span>
    <% end %>
    <%= link_to t('download'),
                '#',
                onclick: 'modal_download.open();' %>
    <span class="menu_bar"></span>
    <%= link_to t('upload'),
                '#',
                onclick: 'modal_upload.open();' %>
  </div> <!-- rightjustify-->
</div> <!-- title_bar-->

<div id="notice">
  <div class="success" id="add_success" style="display: none;"></div>
  <% # This is for error display injected by JavaScript %>

  <div class="error" id="errors" style="display: none; ">
    <h3><%= t("groups.problem") %></h3>
    <div id="errors_title"></div>
    <div id="errors_contents"></div>
  </div>

  <div class="warning" id="warnings_group" style="display: none; ">
    <h3><%= t("groups.warning") %></h3>
    <div id="warnings_group_msg"></div>
  </div>

  <div class="warning" id="warnings_grace" style="display: none; ">
    <h3><%= t("groups.warning") %></h3>
    <div id="warnings_grace_msg"></div>
  </div>

  <div class="warning" id="global_action_warning" style="display: none; ">
    <h3><%= t("groups.warning") %></h3>
    <div id="global_action_warning_msg"></div>
  </div>

  <% # all other flash messages %>
  <%= render 'shared/flash_message' %>
</div><!-- Notice -->

<%= form_tag global_actions_assignment_groups_path(@assignment),
             id: "global_action_form",
             remote: true do %>

  <div class='columns'>

    <div class="col-left">
      <% # order of processing students is important. we go through each member
         # one by one and delete them above from the list of students
         # if they are already in a group
         # See manage/_group.html.erb
      %>
      <div class="tab-pane" id="students-tabs">
        <ul>
          <li>
            <a href="#students_none" id="filter_link_students_none">
              <span><%= raw(I18n.t("groups.all_students")) %></span>
            </a>
          </li>
          <li>
            <a href="#unassigned" id="filter_link_students_unassigned" class="filter_selected">
              <span><%= raw(I18n.t("groups.unassigned_students")) %></span>
            </a>
          </li>
          <li>
            <a href="#assigned" id="filter_link_students_assigned">
              <span><%= raw(I18n.t("groups.assigned_students")) %></span>
            </a>
          </li>
          <li>
            <a href="#inactive" id="filter_link_students_inactive">
              <span><%= raw(I18n.t("groups.inactive_students")) %></span>
            </a>
          </li>
        </ul>

        <div id="students_none"></div>
        <div id="unassigned"></div>
        <div id="assigned"></div>
        <div id="inactive"></div>

        <div class="tabbedArea">
          <div class="search_box">
            <%= text_field_tag 'search_students', nil,
                onkeyup: "students_table.add_filter('search'); students_table.render();",
                onkeypress: "stop_submit(event);",
                placeholder: I18n.t("students.search_students") %>
          </div>

          <div class='table'>
            <table class="students" id="students"></table>
          </div>
        </div>
      </div>
    </div>

    <div class='col-center'>
      <div id='icons'>
        <%= image_submit_tag 'add_arrow.png',
                             onclick: "$('global_actions').setValue('assign');",
                             alt: I18n.t('add_members'),
                             class:'image_input',
                             title: I18n.t('add_members') %>
        <%= image_submit_tag 'remove_arrow.png',
                             onclick: "$('global_actions').setValue('unassign');",
                             alt: I18n.t('remove_members'),
                             title: I18n.t('remove_members'),
                             class:'image_input' %>
      </div>
    </div>

    <div class="col-right">
      <div class="tab-pane" id='groups-tabs'>
        <ul>
          <li>
            <a href="#none" id="filter_link_none" class="filter_selected">
              <span><%= raw(I18n.t("groups.all_grouping_counts")) %></span>
            </a>
          </li>
          <li>
            <a href="#validated" id="filter_link_validated">
              <span><%= raw(I18n.t("groups.valid_grouping_counts")) %></span>
            </a>
          </li>
          <li>
            <a href="#unvalidated" id="filter_link_unvalidated">
              <span><%= raw(I18n.t("groups.not_valid_grouping_counts")) %></span>
            </a>
          </li>
          <li class="button_tab"></li>
        </ul>

        <div id="none"></div>
        <div id="validated"></div>
        <div id="unvalidated"></div>

        <div class="clear"></div>
        <div id="groups_container" class="tabbedArea">

          <div class="search_box">
            <%= text_field_tag 'search_groupings', nil,
                onkeyup: "groupings_table.add_filter('search'); groupings_table.render();",
                onkeypress: "stop_submit(event);",
                placeholder: I18n.t("groups.search_groups") %>
            <%= button_to_function t('groups.add_new'), "make_new_group()", class: 'new_group' %>
          </div>

          <div class="globalActionIconsTop">
            <%= image_submit_tag "icons/tick.png",
              class:'image_input',
              title: I18n.t("groups.action.validate"),
              alt: I18n.t("groups.action.validate"),
              onclick: "$('global_actions').setValue('valid');" %>
            <%= image_submit_tag "icons/cross.png",
              class:'image_input',
              title: I18n.t("groups.action.invalidate"),
              alt: I18n.t("groups.action.invalidate"),
              onclick: "$('global_actions').setValue('invalid');" %>
            <%= image_submit_tag "icons/bin_closed.png",
              class:'image_input', title: I18n.t("groups.action.delete"),
              alt: I18n.t("groups.action.delete"),
              onclick: "$('global_actions').setValue('delete');" %>
          </div>

          <div class='table'>
            <table class="groups" id="groups"></table>
          </div>

          <%= hidden_field_tag 'submit_type', 'global_action', id: 'submit_type' %>
          <%= hidden_field_tag 'global_actions'%>
          <div class="globalActionIconsBottom">
            <%= image_submit_tag "icons/tick.png",
              class:'image_input',
              title: I18n.t("groups.action.validate"),
              alt: I18n.t("groups.action.validate"),
              onclick: "$('global_actions').setValue('valid');" %>
            <%= image_submit_tag "icons/cross.png",
              class:'image_input',
              title: I18n.t("groups.action.invalidate"),
              alt: I18n.t("groups.action.invalidate"),
              onclick: "$('global_actions').setValue('invalid');" %>
            <%= image_submit_tag "icons/bin_closed.png",
              class:'image_input',
              title: I18n.t("groups.action.delete"),
              alt: I18n.t("groups.action.delete"),
              onclick: "$('global_actions').setValue('delete');" %>
          </div>
        </div><!-- group container -->
      </div>
    </div>

  </div>
<% end %> <!-- remote form tag -->


<!-- Modal Windows -->

<aside class='dialog' id="assignment_group_use_dialog">
  <h2><%= I18n.t("groups.reuse_groups") %></h2>
  <fieldset>
    <p><%= I18n.t("groups.assignment_to_use") %></p>
    <select id="clone_groups_assignment_id" name="clone_groups_assignment_id">
      <% @all_assignments.each do |an_assignment| %>
        <% if an_assignment != @assignment && an_assignment.allow_web_submits == false %>
          <option value="<%= an_assignment.id %>"><%= an_assignment.short_identifier %></option>
        <% end %>
      <% end %>
    </select>
  </fieldset>

  <section class='dialog-actions'>
    <%= button_to_function t(:submit),
     "if (confirm(\"#{I18n.t('groups.delete_groups_linked')}\")) submit_assignment_group_use(escape($F('clone_groups_assignment_id')))" %>
    <%= button_to_function t(:cancel), 'modalAssignmentGroupReUse.close()'%>
  </section>
</aside>

<aside class='dialog' id="create_group_dialog">
  <h2><%= I18n.t("groups.create_new_group") %></h2>
  <fieldset>
    <%= I18n.t("groups.groupe_name") %>
    <input type="text" maxlength="30" id="new_group_name"></input>
  </fieldset>

  <section class='dialog-actions'>
    <%= button_to_function I18n.t("groups.create_new_group"),
      "submit_new_group(escape($F('new_group_name')));" %>
    <%= button_to_function t(:cancel), 'modalCreate.close()'%>
  </section>
</aside>

<aside class='dialog' id="rename_group_dialog"></aside>

<aside class='dialog' id="notes_dialog"></aside>

<aside class='dialog' id="download_dialog">
  <h2><%= I18n.t("groups.download.download_groups_file") %></h2>
  <%= link_to t('groups.download.download_csv'),
              { controller: 'groups', action: 'download_grouplist',
                id: @assignment.id },
                onclick: 'modal_download.close();' %>

  <section class='dialog-actions'>
    <%= button_to_function I18n.t('cancel'),
                         'modal_download.close(); return false;' %>
  </section>
</aside>

<aside class='dialog' id="upload_dialog">
  <h2><%= I18n.t("groups.upload.upload_groups_file") %></h2>
  <p>
    <%= I18n.t("groups.upload.description").html_safe %>
    <% if !@assignment.groupings.nil? && @assignment.groupings.length > 0 %>
      <div class="information">
        <%= I18n.t("groups.upload.importing") %>
      </div>
    <% end %>
  </p>
  <%= form_for :group, html: {multipart: true},
                       url: { controller:"groups",
                              action: 'csv_upload',
                              id: @assignment.id } do |f| %>
    <p>
      <%= t("encoding") %>
      <%= select_tag(:encoding, options_for_select(@encodings)) %>
    </p>
    <%= f.file_field :grouplist, size: 2 %>

    <section class='dialog-actions'>
      <%= submit_tag t(:upload), data: { disable_with: t(:uploading_please_wait) } %>
      <%= button_to_function t('cancel'),
                             'modal_upload.close(); return false;' %>
    </section>
  <% end %>
</aside>
