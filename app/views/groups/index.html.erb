<%= javascript_include_tag "livepipe/livepipe.js" %>
<%= javascript_include_tag "livepipe/window.js" %>
<%= javascript_include_tag "livepipe/tabs.js" %>
<%= javascript_include_tag "manage_groups.js" %>
<%= javascript_include_tag "FilterTable/FilterTable.js" %>
<%= javascript_include_tag "Groups/tabs_boot.js" %>
<%= javascript_include_tag "prototype.js" %>

<%= render :partial => "boot.js.erb" %>
<script type="text/javascript">
//<![CDATA[

var modalCreate = null;
var modalAssignmentGroupReUse = null;
var modalRenameGroup = null;
var modalAddMember = null;
var modalNotesGroup = null;
var modalUpload = null;
var modalDownload = null;

function make_new_group() {
   if(<%= @assignment.group_name_autogenerated == false%>)
   {
      modalCreate.open();
      $('new_group_name').setValue('');
      return false;
   } else {
     <%= remote_function(
       :url => new_assignment_group_path(@assignment.id),
       :method => :get )
     %>
   }
}

function submit_new_group(new_group_name) {

  //close the dialog
  modalCreate.close();
  //send AJAX request
  <%=
 remote_function(
    :url  => new_assignment_group_path(@assignment),
    :with => "'&new_group_name=' + new_group_name")
  %>
}

function upload_groups(){
     modalUpload.open();
     return false;
}

function download_groups(){
      modalDownload.open();
      return false;
}

function assignment_group_use() {
    modalAssignmentGroupReUse.open();
    $('clone_groups_assignment_id').setValue('');
    return false;
 }

function submit_assignment_group_use(clone_groups_assignment_id) {

  //close the dialog
  modalAssignmentGroupReUse.close();
  //send AJAX request
  <%=
 remote_function(
    :url  => use_another_assignment_groups_assignment_groups_path(@assignment),
    :with => "'&clone_groups_assignment_id=' + clone_groups_assignment_id")
  %>

}

document.observe("dom:loaded", function(){
    //Create the modal dialog
   modalUpload = new Control.Modal($('upload_dialog'),
   {
     overlayOpacity: 0.75,
     className: 'modalUpload',
     fade: false
   });

   modalDownload = new Control.Modal($('download_dialog'),
   {
     overlayOpacity: 0.75,
     className: 'modalDownload',
     fade: false

   });
  modalCreate = new Control.Modal($('create_group_dialog'),
  {
    overlayOpacity: 0.75,
    className: 'modalCreate',
    fade:false

  });

  modalRenameGroup = new Control.Modal($('rename_group_dialog'),
  {
    overlayOpacity: 0.75,
    className: 'modalRenameGroup',
    fade:false

  });

  modalNotesGroup = new Control.Modal($('notes_dialog'),
  {
    overlayOpacity: 0.75,
    className: 'modalNotesGroup',
    fade:false

  });

 modalAssignmentGroupReUse = new Control.Modal($('assignment_group_use_dialog'),
  {
    overlayOpacity: 0.75,
    className: 'modalAssignmentGroupReUse',
    fade:false
  });
});




//]]>
</script>

<% if @assignment.past_due_date? %>
<div class="notice">
  <%=t('groups.editing_past_due_date_warning')%>
</div>
<% end %>

<div id="title_bar">
  <h1><%=h I18n.t("groups.manage_groups") %></h1>
  <div class="colRightGroups">
      <div class="headingButtons  ">
      <%  # Allow cloning groups forward only if its web submits are disallowed
          # for this assignment.
          if @assignment.allow_web_submits == false %>
        <%= button_to_function t("groups.another_assignment_group"),
          'assignment_group_use(); return false;', :class => "button" %>
        <span class="menu_bar">|</span>
      <% end %>
      <%= button_to_function I18n.t("download"), "download_groups();" %>
      <span class="menu_bar">|</span>
      <%= button_to_function I18n.t("upload"), "upload_groups();" %>
    </div> <!-- rightjustify-->
  </div> <!-- colrightgroups-->

  </div> <!-- title_bar-->


<div class="wrapLeft">
</div>

<div class="clear"></div>

<div id="notice">
    <div class="success" id="add_success" style="display: none; ">
            </div>
  <% # This is for error display injected by JavaScript
   %>

  <div class="error" id="errors" style="display: none; ">
    <h3><%=h t("groups.problem") %></h3>
    <div id="errors_title">
    </div>
    <div id="errors_contents">
    </div>
  </div>

  <div class="warning" id="warnings" style="display: none; ">
    <h3><%=h t("groups.warning") %></h3>
    <div id="warnings_msg">
    </div>
  </div>

  <% # if there are errors have the error message display %>
  <% if flash[:error] || flash[:fail_notice] || flash[:invalid_lines] -%>
    <div class="error">
      <%= h(flash[:error])+"<br/>" if flash[:error] %>
      <%= h(flash[:fail_notice])+"<br/>" if flash[:fail_notice] %>
      <% if flash[:invalid_lines] %>
        <%=h I18n.t("groups.lines_not_processed") %>
        <ul>
        <% flash[:invalid_lines].each do |error| %>
          <li><%=error%></li>
        <% end %>
        </ul>
      <% end %>
    </div>
  <% end %>

  <% # if there are success messages to display
                            %>
  <% if flash[:upload_notice] || flash[:edit_notice] -%>
    <div class="success">
      <%= h(flash[:upload_notice])+"<br/>" if flash[:upload_notice] %>
      <%= h(flash[:edit_notice])+"<br/>" if flash[:edit_notice] %>
    </div>
  <% end %>

</div><!-- Notice -->



<%= form_tag url_for(global_actions_assignment_groups_path(@assignment)),
             :id => "global_action_form",
             :remote => true do %>

<script type='text/javascript'>
$("global_action_form").observe('ajax:after', function(evt, status, data, xhr) {
  thinking();
});

$("global_action_form").observe('ajax:complete', function(evt, status, data, xhr) {
  done_thinking();
});
</script>



<div class="clear"></div>
<div class="colsLeftHeavy">
  <div class="colRightGroups">
    <div class="wrapRightGroups">
      <div class="pane">
        <span id="loading_list">
          <%= image_tag("spinner.gif") %><%=h t("groups.loading_list") %></span>
        <ul id="groups_tabs"class="subsection_tabs">
          <li class="tab">
            <a href="#none" id="filter_link_none" class="filter_selected">
              <%= raw(I18n.t("groups.all_grouping_counts")) %></a></li>
          <li class="tab">
            <a href="#validated" id="filter_link_validated">
              <%= raw(I18n.t("groups.valid_grouping_counts")) %></a></li>
          <li class="tab">
            <a href="#unvalidated" id="filter_link_unvalidated">
              <%= raw(I18n.t("groups.not_valid_grouping_counts")) %></a></li>
          <li class="button_tab">

          </li>
        </ul>
        <div id="none"></div>
        <div id="validated"></div>
        <div id="unvalidated"></div>

        <div class="clear"></div>
        <div id="groups_container" class="tabbedArea">
          <%= label_tag 'search_groupings', "Search:", :class => 'bold_inline_label'%>
          <%= text_field_tag 'search_groupings', nil,
            :onkeyup => "groupings_table.add_filter('search'); groupings_table.render();",
            :onkeypress => "stop_submit(event);"%>
          <%= button_to_function t(:add_new), "make_new_group();" %>
          <div class="globalActionIconsTop">
            <%= image_submit_tag "icons/tick.png",
              :class =>'image_input',
              :title => I18n.t("groups.action.validate"),
              :alt => I18n.t("groups.action.validate"),
              :onclick => "$('global_actions').setValue('valid');" %>
            <%= image_submit_tag "icons/cross.png",
              :class =>'image_input',
              :title => I18n.t("groups.action.invalidate"),
              :alt => I18n.t("groups.action.invalidate"),
              :onclick => "$('global_actions').setValue('invalid');" %>
            <%= image_submit_tag "icons/bin_closed.png",
              :class =>'image_input', :title => I18n.t("groups.action.delete"),
              :alt => I18n.t("groups.action.delete"),
              :onclick => "$('global_actions').setValue('delete');" %>
          </div>
          <table class="groups" id="groups">
          </table>
          <%= hidden_field_tag 'submit_type', 'global_action', :id => 'submit_type' %>
          <%= hidden_field_tag 'global_actions'%>
          <div class="globalActionIconsBottom">
            <%= image_submit_tag "icons/tick.png",
              :class =>'image_input',
              :title => I18n.t("groups.action.validate"),
              :alt => I18n.t("groups.action.validate"),
              :onclick => "$('global_actions').setValue('valid');" %>
            <%= image_submit_tag "icons/cross.png",
              :class =>'image_input',
              :title => I18n.t("groups.action.invalidate"),
              :alt => I18n.t("groups.action.invalidate"),
              :onclick => "$('global_actions').setValue('invalid');" %>
            <%= image_submit_tag "icons/bin_closed.png",
              :class =>'image_input',
              :title => I18n.t("groups.action.delete"),
              :alt => I18n.t("groups.action.delete"),
              :onclick => "$('global_actions').setValue('delete');" %>
          </div>
        </div><!-- group container -->
      </div>
    </div>
  </div> <!-- colRightGroups -->

  <div class="colLeftGroups">
    <% # order of processing students is important. we go through each member
       # one by one and delete them above from the list of students
       # if they are already in a group
       # See manage/_group.html.erb
    %>
    <div class="wrapLeftGroups">
      <div class="pane">
        <span id="loading_students_list">
          <%= image_tag("spinner.gif") %><%=h t("groups.loading_list") %></span>
        <ul id="students_tabs" class="subsection_tabs">
          <li class="tab">
            <a href="#students_none" id="filter_link_students_none">
              <%= raw(I18n.t("groups.all_students")) %></a></li>
          <li class="tab">
            <a href="#unassigned" id="filter_link_students_unassigned" class="filter_selected">
              <%= raw(I18n.t("groups.unassigned_students")) %></a></li>
          <li class="tab"><a href="#assigned" id="filter_link_students_assigned">
            <%= raw(I18n.t("groups.assigned_students")) %></a></li>
        </ul>

        <div id="students_none"></div>
        <div id="unassigned"></div>
        <div id="assigned"></div>

        <div class="tabbedArea">
          <div class="searchBox">
            <%= label_tag 'search_students', "Search:",
              :class => 'bold_inline_label'%>
            <%= text_field_tag 'search_students', nil,
               :onkeyup => "students_table.add_filter('search'); students_table.render();",
               :onkeypress => "stop_submit(event);" %>
          </div>
          <table class="students" id="students">
          </table>
        </div>

      </div>
    </div>
  </div> <!-- colLeftGroups -->

  <div id="centreColumn" class="centreColumn">
      <%= image_submit_tag "add_arrow.png",
        :onclick => "$('global_actions').setValue('assign');",
        :alt => I18n.t('add_members'),
        :class =>'image_input',
        :title => I18n.t('add_members') %>
      <br/><br/>
      <%= image_submit_tag "remove_arrow.png",
        :onclick => "$('global_actions').setValue('unassign');",
        :alt => I18n.t('remove_members'),
        :title => I18n.t('remove_members'),
        :class =>'image_input' %>
  </div>

</div> <!-- ColsLeftHeavy -->
<% end %> <!-- remote form tag -->

<!-- Modal Windows -->



<div id="assignment_group_use_dialog">
  <h2><%= I18n.t("groups.reuse_groups") %></h2>
  <fieldset>
  <p><%= I18n.t("groups.assignment_to_use") %></p>
  <select id="clone_groups_assignment_id" name="clone_groups_assignment_id">
    <% @all_assignments.each do |an_assignment| %>
      <% if an_assignment != @assignment && an_assignment.allow_web_submits == false %>
        <option value="<%=h(an_assignment.id)%>"><%=h(an_assignment.short_identifier)%></option>
      <% end %>
    <% end %>
  </select>
  </fieldset>
  <p class="p_modal">
    <%= button_to_function t(:submit),
     "if (confirm(\"#{I18n.t('groups.delete_groups_linked')}\")) submit_assignment_group_use(escape($F('clone_groups_assignment_id')))" %>
    <%= button_to_function t(:cancel), 'modalAssignmentGroupReUse.close()'%>
  </p>
</div> <!-- Assignement reuse groups modal-->

<div id="create_group_dialog">
  <h2><%= I18n.t("groups.create_new_group") %></h2>
  <fieldset>
  <%= I18n.t("groups.groupe_name") %>
  <input type="text" maxlength="30" id="new_group_name"></input>
  </fieldset>
  <p class="p_modal">
    <%= button_to_function I18n.t("groups.create_new_group"),
  "submit_new_group(escape($F('new_group_name')));" %>
    <%= button_to_function t(:cancel), 'modalCreate.close()'%>
  </p>

</div>

<div id="rename_group_dialog">
</div>

<div id="notes_dialog">
</div>

<div id="download_dialog">
  <h2><%=h I18n.t("groups.download.download_groups_file") %></h2>
  <%= link_to t("groups.download.download_csv"),
    {:controller=>"groups", :action=>"download_grouplist", :id=> @assignment.id}, :onclick => "modalDownload.close();" %>
  <br />
  <br />
  <%= button_to_function I18n.t('cancel'), "modalDownload.close(); return false;" %>
</div>

<div id="upload_dialog">
  <h2><%=h I18n.t("groups.upload.upload_groups_file") %></h2>
  <p>
    <%= I18n.t("groups.upload.description") %>
    <% if !@assignment.groupings.nil? && @assignment.groupings.length > 0 %>
      <br/>
      <div class="information">
        <%= I18n.t("groups.upload.importing") %>
      </div>
    <% end %>
  </p>
  <%= form_for :group, :html => {:multipart => true},
                       :url => { :controller=>"groups",
                               :action => 'csv_upload',
                               :id => @assignment.id } do |f| %>
  <p>
    <%= f.file_field :grouplist, :size => 2 %> <br />
    <%= submit_tag t(:upload), :disable_with => t(:uploading_please_wait) %>
    <%= button_to_function I18n.t('cancel'), "modalUpload.close(); return false;" %>
  </p>
  <% end %>
</div>
