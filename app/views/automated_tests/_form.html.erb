<% content_for :head do %>
  <%= stylesheet_link_tag 'jquery-ui', 'jquery-ui-timepicker-addon' %>
  <%= javascript_include_tag 'jquery-ui-timepicker-addon',
                             'PeriodDeltaChain/PeriodDeltaChain',
                             'localize_date'%>

  <script>
    <%= render partial: 'boot',
               formats: [:js],
               handlers: [:erb] %>
    document.addEventListener('DOMContentLoaded', () => {
      makeAutotestFileManager(document.getElementById('autotest-file-manager'), {assignment_id: <%= @assignment.id %>});
    });
  </script>
  <%= render partial: 'shared/navigation_warning',
             formats: [:js],
             handlers: [:erb] %>
<% end %>

<aside class='dialog' id='addnew_dialog'>
  <h2><%= t('add_new') %></h2>
  <%= form_tag upload_files_assignment_automated_tests_path(assignment_id: @assignment.id),
               { multipart: true, id: 'file_form' } do %>
    <%= file_field_tag :new_files, name: 'new_files[]', multiple: true %>
    <section class='dialog-actions'>
      <%= submit_tag t(:submit) %>
      <%= button_tag t(:close), onclick: 'modal_addnew.close(); return false;' %>
    </section>
  <% end %>
</aside>

<div class="wrapLeft">
  <%= render partial: 'shared/flash_message' %>
</div>

<%= button_to t('automated_tests.fetch_testers'), fetch_testers_automated_test_path(id: @assignment.id) %>

<%= form_for @assignment, url: manage_assignment_automated_tests_path do |f| %>
  <%= render partial: 'shared/error_explanation',
             locals: { model: @assignment } %>
    <p id="testing_framework_style">
      <%= f.check_box :enable_test, id: "is_testing_framework_enabled", onchange: "toggle_tests($('#is_testing_framework_enabled').is(':checked'))" %>
      <%= label_tag "is_testing_framework_enabled", Assignment.human_attribute_name(:enable_test), class: "checkbox_label" %>
    </p>
    <fieldset style="<%= 'display:none;' unless @student_tests_on %>">
      <legend><span><%= t("automated_tests.student_tests") %></span></legend>
      <p>
        <%= f.check_box :enable_student_tests, id: "are_student_tests_enabled", onchange: "toggle_student_tests($('#are_student_tests_enabled').is(':checked'))" %>
        <%= label_tag "are_student_tests_enabled", Assignment.human_attribute_name(:enable_student_tests), class: "checkbox_label" %>
      </p>
      <div id='testing_framework_tokens'>
        <p id='tokens'>
          <%= label_tag :tokens_per_period,
                        t('automated_tests.token.tokens_form'),
                        class: 'inline_label' %>
          <%= f.text_field :tokens_per_period,
                           size: 5, maxlength: 3 %>
          <%= label_tag :token_start_date,
                        t('automated_tests.tokens_available_on'),
                        style: 'margin-left: 20px' %>
          <%= f.text_field :token_start_date,
                           onchange: 'set_onbeforeunload(true);',
                           value: @assignment.token_start_date.nil? ? '' :
                               @assignment.token_start_date.strftime(
                                   '%Y-%m-%d %l:%M %p'),
                           size: 35,
                           placeholder: t('date.formats.datetime_placeholder')%>
          <%= label_tag :token_period, I18n.t("automated_tests.token.tokens_regenerate"),
                        class: 'inline_label' %>
          <%= f.text_field :token_period,
                           size: 5, maxlength: 3,
                           style: "margin-left: -25px" %>
          <%= I18n.t("automated_tests.token.hours")%>
          <%= label_tag :non_regenerating_tokens, t('automated_tests.token.no_regeneration'),
                        class: 'checkbox_label', style: 'text-align: right;' %>
          <%= f.check_box :non_regenerating_tokens,
                          onchange: "toggle_token_regeneration($('#assignment_non_regenerating_tokens').is(':checked'))" %>
          <%= label_tag :unlimited_tokens, t('automated_tests.token.unlimited'),
                        class: 'checkbox_label', style: 'text-align: right;' %>
          <%= f.check_box :unlimited_tokens,
                          onchange: "toggle_tests_tokens($('#assignment_unlimited_tokens').is(':checked'))" %>
        </p>
      </div>
    </fieldset>

    <fieldset>
      <legend><span><%= t("automated_tests.files") %></span></legend>
      <div id='autotest-file-manager'></div>
    </fieldset>

    <fieldset>
      <legend><span><%= t("automated_tests.specs") %></span></legend>
      <p><%= raw t("required_fields") %> <span class='required_field'>*</span></p>

      <div>
        <% @assignment.test_groups.each do |tg| %>
            <%= render partial: 'test_group_upload', locals: { test_group: tg, form: f } %>
        <% end %>
      </div>
    </fieldset>

    <%= f.submit t(:submit), disable_with: I18n.t('working'), onclick: 'set_onbeforeunload(false);' %>
  <% end %>
